{% extends 'accounts/base.html' %}

{% block title %}QR Check-in - CAQM{% endblock %}

{% block extra_css %}
<style>
    /* Mobile-optimized styles */
    #qr-reader {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        border: 2px solid #007bff;
        border-radius: 8px;
    }

    .scanner-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    .result-container {
        margin-top: 20px;
        width: 100%;
        max-width: 600px;
    }

    .alert-custom {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        margin: 20px 0;
    }

    .loading-spinner.active {
        display: block;
    }

    @media (max-width: 768px) {
        .scanner-container {
            padding: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container scanner-container">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h2><i class="fas fa-qrcode"></i> QR Code Check-in</h2>
            <p class="text-muted">Welcome, {{ user.get_full_name }} ({{ user_type }})</p>
            <p class="text-info">
                <i class="fas fa-info-circle"></i>
                Please scan the QR code displayed at reception to check in
            </p>
        </div>
    </div>

    <!-- QR Scanner -->
    <div class="row">
        <div class="col-12">
            <div id="qr-reader"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Processing...</span>
        </div>
        <p class="mt-2">Processing check-in...</p>
    </div>

    <!-- Result Container -->
    <div class="result-container" id="resultContainer">
        <!-- Results will be displayed here -->
    </div>

    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            {% if user.is_patient %}
            <a href="{% url 'appointments:book_appointment' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Appointments
            </a>
            {% elif user.is_doctor %}
            <a href="{% url 'appointments:doctor_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HTML5 QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let html5QrCode;
    let isProcessing = false;

    // Initialize QR Code Scanner
    function initScanner() {
        // Check if library is loaded
        if (typeof Html5Qrcode === 'undefined') {
            console.error('Html5Qrcode library not loaded yet. Retrying...');
            setTimeout(initScanner, 500);
            return;
        }

        try {
            html5QrCode = new Html5Qrcode("qr-reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" }, // Use back camera
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Error starting QR scanner:", err);
                showError("Unable to access camera. Please grant camera permissions.");
            });
        } catch (e) {
            console.error("Error initializing scanner:", e);
            showError("Scanner initialization failed. Please refresh the page.");
        }
    }

    // Handle successful QR scan
    function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return; // Prevent multiple scans

        isProcessing = true;
        console.log("QR Code scanned:", decodedText);

        // Stop scanning
        html5QrCode.stop().then(() => {
            // Show loading spinner
            document.getElementById('loadingSpinner').classList.add('active');

            // Process check-in
            processCheckIn(decodedText);
        }).catch(err => {
            console.error("Error stopping scanner:", err);
            isProcessing = false;
        });
    }

    // Handle scan failure (ignore)
    function onScanFailure(error) {
        // Silently ignore scan failures
    }

    // Process check-in via API
    function processCheckIn(qrData) {
        console.log('Processing check-in with QR data:', qrData);

        const url = "{% url 'queues:process_checkin' %}";
        const csrfToken = getCookie('csrftoken');

        console.log('POST URL:', url);
        console.log('CSRF Token:', csrfToken ? 'Found' : 'Missing');

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ qr_data: qrData })
        })
            .then(response => {
                console.log('Response status:', response.status);

                // Always try to parse JSON, even on error
                return response.json().then(data => ({
                    ok: response.ok,
                    status: response.status,
                    data: data
                }));
            })
            .then(result => {
                console.log('Parsed response:', result);

                // Hide loading spinner
                document.getElementById('loadingSpinner').classList.remove('active');

                if (result.ok && result.data.success) {
                    // Redirect to status page on success
                    window.location.href = "{% url 'queues:queue_status' %}";
                } else {
                    const errorMsg = result.data.message || 'Check-in failed. Please try again.';
                    showError(errorMsg);
                    // Restart scanner on error
                    setTimeout(() => {
                        isProcessing = false;
                        initScanner();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);

                document.getElementById('loadingSpinner').classList.remove('active');
                showError('Network error. Please check your connection and try again.');

                setTimeout(() => {
                    isProcessing = false;
                    initScanner();
                }, 3000);
            });
    }

    // Show success message
    function showSuccess(message, data) {
        let detailsHtml = '';

        if (data) {
            if (data.position !== undefined) {
                // Patient check-in
                detailsHtml = `
                    <div class="mt-3">
                        <p><strong>Queue Position:</strong> #${data.position}</p>
                        <p><strong>Estimated Wait Time:</strong> ${data.estimated_time} minutes</p>
                        <p><strong>Queue Size:</strong> ${data.queue_size} patients</p>
                    </div>
                `;
            } else if (data.consultations_count !== undefined) {
                // Doctor check-in
                detailsHtml = `
                    <div class="mt-3">
                        <p><strong>Consultations Today:</strong> ${data.consultations_count}</p>
                        <p><strong>Patients in Queue:</strong> ${data.queue_size}</p>
                    </div>
                `;
            }
        }

        document.getElementById('resultContainer').innerHTML = `
            <div class="alert alert-success alert-custom">
                <h4><i class="fas fa-check-circle"></i> Success!</h4>
                <p>${message}</p>
                ${detailsHtml}
            </div>
        `;
    }

    // Show error message
    function showError(message) {
        document.getElementById('resultContainer').innerHTML = `
            <div class="alert alert-danger alert-custom">
                <h4><i class="fas fa-exclamation-triangle"></i> Check-in Failed</h4>
                <p>${message}</p>
            </div>
        `;
    }

    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize scanner when page loads
    window.onload = function () {
        console.log('Page loaded, initializing scanner...');
        initScanner();
    };

    // Clean up scanner when page unloads
    window.onbeforeunload = function () {
        if (html5QrCode) {
            html5QrCode.stop();
        }
    };
</script>
{% endblock %}