{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Register New User{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4><i class="fas fa-user-plus"></i> Register New User (Admin)</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="registerForm">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Password <span
                                        class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">First Name <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Last Name <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="phone" name="phone" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                                <select class="form-select" id="role" name="role" required>
                                    <option value="">Select Role...</option>
                                    <option value="PATIENT">Patient</option>
                                    <option value="DOCTOR">Doctor</option>
                                    <option value="NURSE">Nurse</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="date_of_birth" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">Select Gender...</option>
                                    <option value="MALE">Male</option>
                                    <option value="FEMALE">Female</option>
                                </select>
                            </div>
                        </div>

                        <div id="patient-fields" style="display: none;">
                            <h5 class="mt-3">Patient Information</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="emergency_contact" class="form-label">Emergency Contact</label>
                                    <input type="tel" class="form-control" id="emergency_contact"
                                        name="emergency_contact">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="doctor-fields" style="display: none;">
                            <h5 class="mt-3">Doctor Information</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="specialization" class="form-label">Specialization <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="specialization" name="specialization">
                                        <option value="">Select Specialization...</option>
                                        <option value="CARDIOLOGY">Cardiology</option>
                                        <option value="DERMATOLOGY">Dermatology</option>
                                        <option value="GENERAL">General Medicine</option>
                                        <option value="NEUROLOGY">Neurology</option>
                                        <option value="ORTHOPEDICS">Orthopedics</option>
                                        <option value="PEDIATRICS">Pediatrics</option>
                                        <option value="PSYCHIATRY">Psychiatry</option>
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="license_number" class="form-label">License Number</label>
                                    <input type="text" class="form-control" id="license_number" name="license_number">
                                </div>
                            </div>
                        </div>

                        <div id="nurse-fields" style="display: none;">
                            <h5 class="mt-3">Nurse Information</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> The assigned doctor is optional and can be set later
                                through Django admin panel.
                            </div>
                            <div class="mb-3">
                                <label for="assigned_doctor" class="form-label">Assigned Doctor (Optional)</label>
                                <select class="form-select" id="assigned_doctor" name="assigned_doctor">
                                    <option value="">None - Assign Later</option>
                                </select>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'admins:admin_user_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-check-circle"></i> Register User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadDoctors() {
        try {
            const response = await fetch('/admins/api/doctors/');
            if (response.ok) {
                const doctors = await response.json();
                const select = document.getElementById('assigned_doctor');
                const existingOptions = select.querySelectorAll('option:not(:first-child)');
                existingOptions.forEach(opt => opt.remove());
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = `Dr. ${doctor.name} - ${doctor.specialization}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.log('Could not load doctors list');
        }
    }

    document.getElementById('role').addEventListener('change', function () {
        const patientFields = document.getElementById('patient-fields');
        const doctorFields = document.getElementById('doctor-fields');
        const nurseFields = document.getElementById('nurse-fields');
        const specialization = document.getElementById('specialization');

        patientFields.style.display = 'none';
        doctorFields.style.display = 'none';
        nurseFields.style.display = 'none';
        specialization.required = false;

        if (this.value === 'PATIENT') {
            patientFields.style.display = 'block';
        } else if (this.value === 'DOCTOR') {
            doctorFields.style.display = 'block';
            specialization.required = true;
        } else if (this.value === 'NURSE') {
            nurseFields.style.display = 'block';
            loadDoctors();
        }
    });
</script>
{% endblock %}
